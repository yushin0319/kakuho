name: Gemini Code Review
on:
  pull_request:
    types: [opened, synchronize]
jobs:
  review:
    runs-on: ubuntu-latest
    permissions:
      contents: read
      pull-requests: write
    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - uses: actions/setup-python@v5
        with:
          python-version: "3.12"

      - name: Install dependencies
        run: pip install google-genai

      - name: Run Gemini review
        env:
          GEMINI_API_KEY: ${{ secrets.GEMINI_API_KEY }}
          GH_TOKEN: ${{ github.token }}
          PR_NUMBER: ${{ github.event.pull_request.number }}
          BASE_SHA: ${{ github.event.pull_request.base.sha }}
          HEAD_SHA: ${{ github.event.pull_request.head.sha }}
          PROMPT_FILE: ${{ github.workspace }}/.github/workflows/gemini-prompt.txt
        run: |
          git diff -U10 "$BASE_SHA" "$HEAD_SHA" > /tmp/diff.txt

          python - <<'PYEOF'
          import os, sys
          from google import genai
          from google.genai import types

          with open("/tmp/diff.txt") as f:
              diff = f.read()

          if not diff.strip():
              print("No diff found, skipping review.")
              with open("/tmp/review.txt", "w") as f:
                  f.write("No changes to review.")
              sys.exit(0)

          prompt_path = os.environ.get("PROMPT_FILE", "")
          if prompt_path and os.path.exists(prompt_path):
              with open(prompt_path) as f:
                  prompt = f.read()
          else:
              prompt = "Review this PR's changes. Respond in Japanese."

          client = genai.Client(api_key=os.environ["GEMINI_API_KEY"])
          response = client.models.generate_content(
              model="gemini-2.5-flash",
              contents=f"## PR Diff:\n```\n{diff}\n```\n\n{prompt}",
              config=types.GenerateContentConfig(
                  system_instruction="You are a code review assistant reviewing pull request changes.",
                  temperature=0.0,
              ),
          )

          with open("/tmp/review.txt", "w") as f:
              f.write(response.text)
          print(response.text)
          PYEOF

          BODY=$(cat <<EOF
          # Code Review by Gemini

          $(cat /tmp/review.txt)
          EOF
          )
          gh pr comment "$PR_NUMBER" --body "$BODY"
